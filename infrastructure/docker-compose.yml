version: '3.8'

services:
  # ===========================================================================
  # nginx - Reverse Proxy with WebSocket Support
  # ===========================================================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # api - Flask + Socket.IO (Single Worker for WebSocket State)
  # ===========================================================================
  api:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - CAMPAIGNS_DIR=/data/campaigns
      - RAG_DB_PATH=/data/rag/pathfinder_search.db
    env_file:
      - .env.docker
    volumes:
      - campaigns-data:/data/campaigns
      - rag-data:/data/rag:ro
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    # Single worker required: WebSocket state, GameLoopController timers,
    # _active_agents dict are all process-bound
    command: >
      gunicorn
      --worker-class eventlet
      -w 1
      -b 0.0.0.0:5000
      --timeout 120
      --graceful-timeout 30
      --keep-alive 65
      wsgi:app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    stop_grace_period: 30s

  # ===========================================================================
  # celery-worker - Async LLM Task Processing
  # ===========================================================================
  celery-worker:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - CAMPAIGNS_DIR=/data/campaigns
      - RAG_DB_PATH=/data/rag/pathfinder_search.db
    env_file:
      - .env.docker
    volumes:
      - campaigns-data:/data/campaigns
      - rag-data:/data/rag:ro
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    command: >
      celery -A gm_agent.tasks worker
      --loglevel=info
      --concurrency=4
      --pool=prefork
    healthcheck:
      test: ["CMD", "celery", "-A", "gm_agent.tasks", "inspect", "ping", "-d", "celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    stop_grace_period: 30s

  # ===========================================================================
  # redis - Task Broker & Result Backend
  # ===========================================================================
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy volatile-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # cli - Admin Commands (Profile-Activated)
  # ===========================================================================
  cli:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    environment:
      - CAMPAIGNS_DIR=/data/campaigns
      - RAG_DB_PATH=/data/rag/pathfinder_search.db
      # MCP remote mode: CLI calls API which dispatches to Celery workers
      - MCP_MODE=remote
      - MCP_API_URL=http://api:5000
    env_file:
      - .env.docker
    volumes:
      - campaigns-data:/data/campaigns
      - rag-data:/data/rag:ro
    depends_on:
      api:
        condition: service_healthy
    profiles:
      - cli
    entrypoint: ["python", "-m", "cli"]
    stdin_open: true
    tty: true

volumes:
  campaigns-data:
    driver: local
  rag-data:
    driver: local
  redis-data:
    driver: local

networks:
  default:
    name: gm-agent-network
